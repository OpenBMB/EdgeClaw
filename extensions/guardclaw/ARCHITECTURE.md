# GuardClaw éšç§ä¿æŠ¤æœºåˆ¶ - æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

GuardClaw æ˜¯ OpenClaw çš„éšç§ä¿æŠ¤æ‰©å±•ï¼Œé€šè¿‡æ•æ„Ÿå†…å®¹æ£€æµ‹å’Œä¼šè¯éš”ç¦»æœºåˆ¶ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯ä»…åœ¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¼šå‘é€åˆ°äº‘ç«¯æ¨¡å‹ã€‚

**è®¾è®¡åŸåˆ™**: GuardClaw å®Œå…¨ä½œä¸ºæ’ä»¶å®ç°ï¼Œä¸ä¾µå…¥ OpenClaw æ ¸å¿ƒä»£ç ã€‚å®ƒåˆ©ç”¨ OpenClaw çš„æ ‡å‡†æ’ä»¶ API å’Œ Hook ç³»ç»Ÿæ¥å®ç°æ‰€æœ‰åŠŸèƒ½ã€‚

## æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·æ¶ˆæ¯                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GuardClaw resolve_model Hook                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²æ ‡è®°ä¸ºç§å¯†                                        â”‚   â”‚
â”‚  â”‚  2. å¦‚æœå¦ï¼Œè°ƒç”¨æœ¬åœ°æ¨¡å‹æ£€æµ‹æ•æ„Ÿåº¦                                   â”‚   â”‚
â”‚  â”‚  3. æ ¹æ®æ•æ„Ÿåº¦çº§åˆ«å†³å®šè·¯ç”±                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         S1 (æ™®é€šå†…å®¹)          â”‚   â”‚        S2/S3 (æ•æ„Ÿå†…å®¹)            â”‚
â”‚                               â”‚   â”‚                                   â”‚
â”‚  â†’ ä½¿ç”¨äº‘ç«¯æ¨¡å‹ (å¦‚ Claude)    â”‚   â”‚  â†’ é‡å®šå‘åˆ° Guard å­ä¼šè¯            â”‚
â”‚  â†’ ä¸»ä¼šè¯å¤„ç†                  â”‚   â”‚  â†’ ä½¿ç”¨æœ¬åœ°æ¨¡å‹ (Ollama)            â”‚
â”‚  â†’ å“åº”ç›´æ¥è¿”å›                â”‚   â”‚  â†’ å“åº”æ³¨å…¥å›ä¸»ä¼šè¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•æ„Ÿåº¦çº§åˆ«

| çº§åˆ« | æè¿° | å¤„ç†æ–¹å¼ | ç¤ºä¾‹ |
|------|------|----------|------|
| **S1** | æ™®é€šå†…å®¹ | äº‘ç«¯æ¨¡å‹ | ä¸€èˆ¬å¯¹è¯ã€æŠ€æœ¯é—®é¢˜ |
| **S2** | ä¸­åº¦æ•æ„Ÿ | æœ¬åœ°æ¨¡å‹ | ä¸ªäººåå¥½ã€ä½ç½®ä¿¡æ¯ |
| **S3** | é«˜åº¦æ•æ„Ÿ | æœ¬åœ°æ¨¡å‹ + éš”ç¦» | å¯†ç ã€å¯†é’¥ã€è´¢åŠ¡ä¿¡æ¯ |

## ä¼šè¯éš”ç¦»æœºåˆ¶

### å­ä¼šè¯ (Subsession) æ¶æ„

```
ä¸»ä¼šè¯: agent:main:main
    â”‚
    â””â”€â”€ Guard å­ä¼šè¯: agent:main:main:guard
            â”‚
            â”œâ”€â”€ å­˜å‚¨å®Œæ•´æ•æ„Ÿæ¶ˆæ¯
            â”œâ”€â”€ å­˜å‚¨å®Œæ•´å“åº”å†…å®¹
            â””â”€â”€ ç‹¬ç«‹çš„ä¼šè¯å†å²
```

### æ•°æ®æµ

```
1. ç”¨æˆ·å‘é€æ•æ„Ÿæ¶ˆæ¯
   â”‚
   â–¼
2. GuardClaw æ£€æµ‹åˆ° S2/S3 å†…å®¹
   â”‚
   â–¼
3. æ¶ˆæ¯è·¯ç”±åˆ° Guard å­ä¼šè¯
   â”‚
   â”œâ”€â”€ Guard å­ä¼šè¯ï¼šå­˜å‚¨åŸå§‹æ•æ„Ÿæ¶ˆæ¯
   â”‚
   â–¼
4. æœ¬åœ° Ollama æ¨¡å‹å¤„ç†
   â”‚
   â–¼
5. å“åº”å®Œæˆå
   â”‚
   â”œâ”€â”€ Guard å­ä¼šè¯ï¼šå­˜å‚¨å®Œæ•´å“åº”
   â”‚
   â””â”€â”€ ä¸»ä¼šè¯ï¼šæ³¨å…¥å ä½ç¬¦å’Œå“åº”æ‘˜è¦
       â”œâ”€â”€ ğŸ”’ [Private message - processed locally]
       â””â”€â”€ ğŸ”’ [Response from local model] + å“åº”å†…å®¹
```

## ä¼šè¯çŠ¶æ€ç®¡ç†

### ä¼šè¯ç§å¯†æ ‡è®°

æ–‡ä»¶: `extensions/guardclaw/src/session-state.ts`

```typescript
interface SessionPrivacyState {
  sessionKey: string;
  isPrivate: boolean;           // ä¼šè¯æ˜¯å¦å·²æ ‡è®°ä¸ºç§å¯†
  highestLevel: SensitivityLevel; // ä¼šè¯ä¸­æ£€æµ‹åˆ°çš„æœ€é«˜æ•æ„Ÿåº¦
  detectionHistory: Detection[];  // æ£€æµ‹å†å²è®°å½•
}
```

### çŠ¶æ€æŒä¹…åŒ–

- ä¼šè¯çŠ¶æ€å­˜å‚¨åœ¨å†…å­˜ä¸­ (`Map<string, SessionPrivacyState>`)
- ä¸€æ—¦ä¼šè¯è¢«æ ‡è®°ä¸ºç§å¯† (S2/S3)ï¼Œåç»­æ‰€æœ‰æ¶ˆæ¯éƒ½ä½¿ç”¨æœ¬åœ°æ¨¡å‹
- è¿™ç¡®ä¿æ•æ„Ÿå†å²ä¸ä¼šæ³„éœ²åˆ°äº‘ç«¯

## æ ¸å¿ƒç»„ä»¶

### 1. resolve_model Hook

æ–‡ä»¶: `extensions/guardclaw/src/hooks.ts`

```typescript
api.on("resolve_model", async (event, ctx) => {
  // 1. æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²ç§å¯†
  const isSessionPrivate = getSessionHighestLevel(sessionKey) >= "S2";
  
  // 2. æ£€æµ‹å½“å‰æ¶ˆæ¯æ•æ„Ÿåº¦
  const sensitivity = await detectSensitivity(message, config);
  
  // 3. å¦‚æœæ•æ„Ÿï¼Œè¿”å›æœ¬åœ°æ¨¡å‹ + Guard å­ä¼šè¯
  if (sensitivity >= "S2") {
    return {
      provider: "ollama",
      model: "llama3.2:3b",
      sessionKey: `${sessionKey}:guard`  // é‡å®šå‘åˆ°å­ä¼šè¯
    };
  }
});
```

### 2. æ•æ„Ÿåº¦æ£€æµ‹å™¨

æ–‡ä»¶: `extensions/guardclaw/src/sensitivity-detector.ts`

ä½¿ç”¨æœ¬åœ° Ollama æ¨¡å‹åˆ†ææ¶ˆæ¯å†…å®¹ï¼š

```typescript
async function detectSensitivity(message: string): Promise<{
  highestLevel: SensitivityLevel;
  reason?: string;
}> {
  // è°ƒç”¨ Ollama æ¨¡å‹åˆ†ææ¶ˆæ¯
  // è¿”å› S1/S2/S3 çº§åˆ«
}
```

### 3. Gateway é›†æˆ

æ–‡ä»¶: `src/gateway/server-methods/chat.ts`

```typescript
// chat.send å¤„ç†æµç¨‹
1. è°ƒç”¨ resolve_model hook è·å–æ¨¡å‹å’Œä¼šè¯é‡å®šå‘
2. å¦‚æœæœ‰ä¼šè¯é‡å®šå‘ï¼š
   - effectiveSessionKey = guardSessionKey
   - originalSessionKey = åŸå§‹ä¼šè¯
3. ä½¿ç”¨ effectiveSessionKey è¿è¡Œ agent
4. å®Œæˆåï¼Œå°†å“åº”æ³¨å…¥å› originalSessionKey
```

### 4. å“åº”æ³¨å…¥

å®Œæˆå¤„ç†åï¼Œè‡ªåŠ¨å°†ç»“æœæ³¨å…¥ä¸»ä¼šè¯ï¼š

```typescript
// è¯»å– guard å­ä¼šè¯çš„æœ€ç»ˆå“åº”
const guardResponse = readLastAssistantMessage(guardSessionKey);

// æ³¨å…¥åˆ°ä¸»ä¼šè¯
appendUserTranscriptMessage({
  message: "ğŸ”’ [Private message - processed locally]",
  sessionKey: originalSessionKey
});

appendAssistantTranscriptMessage({
  message: `ğŸ”’ [Response from local model]\n\n${guardResponse}`,
  sessionKey: originalSessionKey
});
```

## æ’ä»¶äº‹ä»¶ç³»ç»Ÿ

GuardClaw ä½¿ç”¨ OpenClaw çš„é€šç”¨æ’ä»¶äº‹ä»¶ç³»ç»Ÿå¹¿æ’­çŠ¶æ€å˜åŒ–ï¼š

### å‘å°„äº‹ä»¶ï¼ˆæ’ä»¶ä¾§ï¼‰

```typescript
// extensions/guardclaw/src/hooks.ts
api.emitEvent("privacy_activated", {
  active: true,
  level: "S3",
  model: "ollama/llama3.2:3b",
  provider: "ollama",
  reason: "S3 content detected",
  sessionKey: "agent:main:main:guard",
  originalSessionKey: "agent:main:main",
});
```

### äº‹ä»¶å¹¿æ’­ï¼ˆGatewayï¼‰

```typescript
// src/gateway/server.impl.ts
onPluginEvent((evt) => {
  broadcast("plugin_event", {
    plugin: evt.pluginId,    // "guardclaw"
    type: evt.eventType,     // "privacy_activated"
    ...evt.payload
  });
});
```

### äº‹ä»¶æ¥æ”¶ï¼ˆUIï¼‰

```typescript
// ui/src/ui/app-gateway.ts
if (evt.event === "plugin_event") {
  if (payload?.plugin === "guardclaw" && payload.type === "privacy_activated") {
    // æ›´æ–° UI çŠ¶æ€æŒ‡ç¤ºå™¨
  }
}
```

## UI é›†æˆ

### GuardClaw çŠ¶æ€æŒ‡ç¤ºå™¨

å½“ GuardClaw æ¿€æ´»æ—¶ï¼ŒUI æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ï¼š

```typescript
// WebSocket äº‹ä»¶ï¼ˆé€šç”¨ plugin_event æ ¼å¼ï¼‰
{
  event: "plugin_event",
  payload: {
    plugin: "guardclaw",
    type: "privacy_activated",
    active: true,
    level: "S3",
    model: "ollama/llama3.2:3b",
    provider: "ollama",
    reason: "S3 content detected"
  }
}
```

### å‰ç«¯æ˜¾ç¤º

æ–‡ä»¶: `ui/src/ui/views/chat.ts`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’ GuardClaw Active                   â”‚
â”‚  Level: S3 | Model: ollama/llama3.2:3b â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®

### openclaw.json é…ç½®ç¤ºä¾‹

```json
{
  "plugins": {
    "entries": {
      "guardclaw": {
        "enabled": true,
        "privacy": {
          "enabled": true,
          "localModel": {
            "provider": "ollama",
            "model": "llama3.2:3b"
          },
          "sensitivity": {
            "S1": { "model": "cloud" },
            "S2": { "model": "local" },
            "S3": { "model": "local" }
          }
        }
      }
    }
  }
}
```

## æ–‡ä»¶ç»“æ„

### æ’ä»¶ä»£ç ï¼ˆå®Œå…¨è‡ªåŒ…å«ï¼‰

```
extensions/guardclaw/
â”œâ”€â”€ README.md                 # ç”¨æˆ·æ–‡æ¡£
â”œâ”€â”€ ARCHITECTURE.md           # æœ¬æ–‡æ¡£
â”œâ”€â”€ REFACTORING.md           # é‡æ„è®¡åˆ’
â”œâ”€â”€ package.json
â””â”€â”€ src/
    â”œâ”€â”€ index.ts              # æ’ä»¶å…¥å£
    â”œâ”€â”€ hooks.ts              # æ‰€æœ‰ hook å®ç°ï¼ˆresolve_model ç­‰ï¼‰
    â”œâ”€â”€ config.ts             # é…ç½®å®šä¹‰
    â”œâ”€â”€ config-schema.ts      # é…ç½® schema
    â”œâ”€â”€ types.ts              # ç±»å‹å®šä¹‰
    â”œâ”€â”€ session-state.ts      # ä¼šè¯çŠ¶æ€ç®¡ç†
    â”œâ”€â”€ detector.ts           # æ•æ„Ÿåº¦æ£€æµ‹å™¨
    â””â”€â”€ local-model.ts        # æœ¬åœ°æ¨¡å‹è°ƒç”¨
```

### OpenClaw æ ¸å¿ƒæ‰©å±•ç‚¹ï¼ˆé€šç”¨ï¼Œé GuardClaw ç‰¹å®šï¼‰

```
src/plugins/
â”œâ”€â”€ types.ts                  # é€šç”¨ hook ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ PluginHookResolveModelResult  # resolve_model è¿”å›ç±»å‹
â”œâ”€â”€ hooks.ts                  # Hook runner
â”‚   â””â”€â”€ runResolveModel()     # æ‰§è¡Œ resolve_model hook
â”œâ”€â”€ plugin-events.ts          # é€šç”¨æ’ä»¶äº‹ä»¶ç³»ç»Ÿ â† æ–°å¢
â”‚   â”œâ”€â”€ emitPluginEvent()     # æ’ä»¶å‘å°„äº‹ä»¶
â”‚   â””â”€â”€ onPluginEvent()       # è®¢é˜…æ’ä»¶äº‹ä»¶
â””â”€â”€ registry.ts               # æ’ä»¶æ³¨å†Œ
    â””â”€â”€ api.emitEvent()       # æ’ä»¶ API äº‹ä»¶æ–¹æ³•

src/gateway/
â”œâ”€â”€ server.impl.ts            # WebSocket æœåŠ¡å™¨
â”‚   â””â”€â”€ onPluginEvent()       # è®¢é˜…å¹¶å¹¿æ’­æ’ä»¶äº‹ä»¶
â””â”€â”€ server-methods-list.ts
    â””â”€â”€ "plugin_event"        # é€šç”¨æ’ä»¶äº‹ä»¶ç±»å‹
```

### UI ä»£ç 

```
ui/src/ui/
â”œâ”€â”€ views/chat.ts             # GuardClaw æŒ‡ç¤ºå™¨ç»„ä»¶
â””â”€â”€ app-gateway.ts            # å¤„ç† plugin_event äº‹ä»¶
```

## å®‰å…¨è€ƒè™‘

### æ•°æ®éš”ç¦»

1. **æ•æ„Ÿæ¶ˆæ¯** - ä»…å­˜å‚¨åœ¨ Guard å­ä¼šè¯ä¸­
2. **ä¸»ä¼šè¯** - åªåŒ…å«å ä½ç¬¦ï¼Œä¸å«åŸå§‹æ•æ„Ÿå†…å®¹
3. **äº‘ç«¯æ¨¡å‹** - æ°¸è¿œä¸ä¼šçœ‹åˆ° S2/S3 çº§åˆ«çš„å†…å®¹

### ä¼šè¯çº§ä¿æŠ¤

ä¸€æ—¦ä¼šè¯ä¸­å‡ºç°æ•æ„Ÿå†…å®¹ï¼š
- æ•´ä¸ªä¼šè¯è¢«æ ‡è®°ä¸ºç§å¯†
- åç»­æ‰€æœ‰æ¶ˆæ¯éƒ½ä½¿ç”¨æœ¬åœ°æ¨¡å‹
- é˜²æ­¢å†å²ä¸Šä¸‹æ–‡æ³„éœ²

### æœ¬åœ°å¤„ç†

- Ollama åœ¨æœ¬åœ°è¿è¡Œ
- æ•°æ®ä¸ç¦»å¼€ç”¨æˆ·è®¾å¤‡
- æ— ç½‘ç»œä¼ è¾“æ•æ„Ÿä¿¡æ¯

### æ’ä»¶éš”ç¦»

- GuardClaw å®Œå…¨ä½œä¸ºæ’ä»¶è¿è¡Œ
- ä¸ä¿®æ”¹ OpenClaw æ ¸å¿ƒä»£ç 
- é€šè¿‡æ ‡å‡† API ä¸ç³»ç»Ÿäº¤äº’
- å¯ç‹¬ç«‹æ›´æ–°å’Œéƒ¨ç½²

## é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

1. **æ€§èƒ½** - æœ¬åœ°æ¨¡å‹å“åº”è¾ƒæ…¢ï¼ˆ10-20ç§’ï¼‰
2. **è´¨é‡** - æœ¬åœ°å°æ¨¡å‹èƒ½åŠ›æœ‰é™
3. **æ£€æµ‹å‡†ç¡®æ€§** - æ•æ„Ÿåº¦æ£€æµ‹å¯èƒ½æœ‰è¯¯æŠ¥/æ¼æŠ¥
4. **å†…å­˜** - Guard å­ä¼šè¯ä¼šå¢åŠ å­˜å‚¨å¼€é”€

## æœªæ¥æ”¹è¿›

- [ ] æ”¯æŒæ›´å¤šæœ¬åœ°æ¨¡å‹é€‰é¡¹
- [ ] æ”¹è¿›æ•æ„Ÿåº¦æ£€æµ‹ç®—æ³•
- [ ] æ·»åŠ æ•æ„Ÿè¯è‡ªå®šä¹‰é…ç½®
- [ ] æ”¯æŒç«¯åˆ°ç«¯åŠ å¯†çš„ Guard ä¼šè¯
- [ ] UI ä¸­æ˜¾ç¤º Guard å­ä¼šè¯å†å²çš„é€‰é¡¹

